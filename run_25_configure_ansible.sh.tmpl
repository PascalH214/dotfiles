#!/bin/bash

# Define colors
GREEN='\033[0;32m'
BLUE='\033[0;34m'
BOLD='\033[1m'
RED='\033[0;31m'
YELLOW='\033[0;33m'
NC='\033[0m'

# Function to run an ansible playbook
run_ansible_playbook() {
  local playbook_name="$1"
  local playbook_file="$2"

  if [ ! -f "${playbook_file}" ]; then
    echo -e "${RED}Error: Ansible playbook not found at ${playbook_file}${NC}"
    return 1
  fi

  echo -e "${BLUE}======================================${NC}"
  echo -e "${BOLD}${playbook_name}${NC}"
  echo -e "${BLUE}======================================${NC}\n"

  ANSIBLE_BECOME_PASS="${BECOME_PASSWORD}" ansible-playbook "${playbook_file}"

  if [ $? -eq 0 ]; then
    echo -e "\n${GREEN}✓ ${playbook_name} completed successfully${NC}\n"
    return 0
  else
    echo -e "\n${RED}✗ ${playbook_name} failed${NC}\n"
    return 1
  fi
}

echo -e "${BLUE}======================================${NC}"
echo -e "${BOLD}Configure System with Ansible${NC}"
echo -e "${BLUE}======================================${NC}\n"

# Check if ansible is installed
if ! command -v ansible-playbook &> /dev/null; then
    echo -e "${RED}Error: ansible is not installed${NC}"
    echo -e "${YELLOW}Please install ansible first: sudo pacman -S ansible (Arch) or sudo apt install ansible (Ubuntu)${NC}"
    exit 1
fi

# Get the chezmoi source directory
ANSIBLE_DIR="{{ .chezmoi.sourceDir }}/ansible_playbooks"

# Define playbooks to run
declare -a PLAYBOOKS=(
  "Configure system timezone:${ANSIBLE_DIR}/timezone.yml"
  "Configure iwd (iNet Wireless Daemon):${ANSIBLE_DIR}/iwd.yml"
  "Add Windows entry to GRUB:${ANSIBLE_DIR}/grub_windows.yml"
  "Configure Ly display manager:${ANSIBLE_DIR}/ly_config.yml"

)

# Track failures and skipped
failed=0
skipped=0

# Ask if user wants to proceed
read -p "Do you want to configure Ansible playbooks? (y/n): " -n 1 -r
echo
if ! [[ $REPLY =~ ^[Yy]$ ]]; then
  echo -e "${YELLOW}Ansible configuration cancelled${NC}\n"
  exit 0
fi

# Ask for password once
read -sp "Enter sudo password: " BECOME_PASSWORD
echo ""

# Run all playbooks
for playbook_entry in "${PLAYBOOKS[@]}"; do
  IFS=':' read -r playbook_name playbook_file <<< "${playbook_entry}"
  
  if [[ $REPLY =~ ^[Yy]$ ]]; then
    run_ansible_playbook "${playbook_name}" "${playbook_file}" || ((failed++))
  else
    echo -e "${YELLOW}⊘ ${playbook_name} skipped${NC}\n"
    ((skipped++))
  fi
done

echo -e "${BLUE}======================================${NC}"
if [ ${failed} -eq 0 ]; then
  if [ ${skipped} -eq 0 ]; then
    echo -e "${GREEN}✓ All Ansible configurations completed successfully${NC}"
  else
    echo -e "${GREEN}✓ Ansible configurations completed (${skipped} skipped)${NC}"
  fi
  echo -e "${BLUE}======================================${NC}\n"
  exit 0
else
  echo -e "${RED}✗ ${failed} Ansible configuration(s) failed${NC}"
  if [ ${skipped} -gt 0 ]; then
    echo -e "${YELLOW}(${skipped} playbooks skipped)${NC}"
  fi
  echo -e "${BLUE}======================================${NC}\n"
  exit 1
fi

# Clear the password from memory
unset BECOME_PASSWORD
