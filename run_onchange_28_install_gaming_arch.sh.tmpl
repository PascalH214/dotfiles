#!/bin/bash

# Define colors
GREEN='\033[0;32m'
BLUE='\033[0;34m'
BOLD='\033[1m'
RED='\033[0;31m'
YELLOW='\033[1;33m'
NC='\033[0m'

print_section() {
  echo -e "${BLUE}======================================${NC}"
  echo -e "${BOLD}$1${NC}"
  echo -e "${BLUE}======================================${NC}\n"
}

print_success() {
  echo -e "${GREEN}✓ $1${NC}\n"
}

print_info() {
  echo -e "${BLUE}ℹ $1${NC}"
}

print_warning() {
  echo -e "${YELLOW}⚠ $1${NC}"
}

{{ if eq .os "arch-linux" -}}

{{ if .install_gaming -}}

print_section "Gaming Setup for Arch Linux"

# Check if yay is available
if ! command -v yay >/dev/null 2>&1; then
  echo -e "${RED}error:${NC} yay not installed" >&2
  exit 1
fi

# Install core gaming packages
print_info "Installing core gaming packages..."

yay -S --noconfirm --needed \
  steam \
  proton-ge-custom-bin \
  gamemode \
  gamescope \
  wine \
  wine-gecko \
  wine-mono \
  winetricks \
  lutris \
  heroic-games-launcher

print_success "Core gaming packages installed"

# Install gaming libraries and dependencies
print_info "Installing gaming libraries..."

yay -S --noconfirm --needed \
  vulkan-tools \
  lib32-vulkan-tools \
  dxvk-bin \
  lib32-dxvk-bin \
  vkd3d \
  lib32-vkd3d \
  openal \
  lib32-openal

print_success "Gaming libraries installed"

# Install game launchers and utilities
print_info "Installing game launchers and utilities..."

yay -S --noconfirm --needed \
  goverlay \
  mangohud \
  lib32-mangohud \
  bottles

print_success "Game launchers and utilities installed"

# Install performance monitoring tools
print_info "Installing performance monitoring tools..."

yay -S --noconfirm --needed \
  cpu-x \
  gpu-burn

print_success "Performance monitoring tools installed"

# Install GPU-specific monitoring tools based on vendor
gpu_vendor="{{ .gpu_vendor }}"

if [ "$gpu_vendor" != "none" ]; then
  print_info "Installing GPU-specific monitoring tools for $gpu_vendor..."
  
  case "$gpu_vendor" in
    amd)
      # AMD-specific tools (radeontop already installed in GPU driver script)
      yay -S --noconfirm --needed rocm-opencl-runtime
      print_success "AMD monitoring tools installed"
      ;;
    nvidia)
      # NVIDIA-specific tools
      yay -S --noconfirm --needed nvidia-settings nvidia-utils
      print_success "NVIDIA monitoring tools installed"
      ;;
    intel)
      # Intel-specific tools
      yay -S --noconfirm --needed intel-gpu-tools intel-media-driver
      print_success "Intel monitoring tools installed"
      ;;
  esac
fi

# Install universal benchmarking tool
yay -S --noconfirm --needed unigine-superposition

print_success "GPU-specific and benchmarking tools installed"

# Install peripheral tools
print_info "Installing gaming peripheral tools..."

yay -S --noconfirm --needed \
  piper \
  solaar \
  openrgb

print_success "Gaming peripheral tools installed"

# Configure kernel parameters for gaming
print_section "Configuring Kernel Parameters for Gaming"

# Create sysctl configuration for gaming optimizations
print_info "Setting up kernel parameters for gaming..."

if [ ! -f /etc/sysctl.d/80-gamecompatibility.conf ]; then
  sudo tee /etc/sysctl.d/80-gamecompatibility.conf > /dev/null <<'EOF'
# Gaming kernel parameters for better performance and compatibility
# Based on Arch Linux Gaming Wiki

# Increase vm.max_map_count for better memory management (SteamOS default)
vm.max_map_count = 2147483642

# Memory management for reduced jitter
vm.compaction_proactiveness = 0
vm.watermark_boost_factor = 1
vm.watermark_scale_factor = 500
vm.swappiness = 10
vm.page_lock_unfairness = 1

# Zone reclaim and transparent hugepages
vm.zone_reclaim_mode = 0
vm.mmap_min_addr = 65536

# Process scheduling optimizations
kernel.sched_child_runs_first = 0
kernel.sched_autogroup_enabled = 1
kernel.sched_cfs_bandwidth_slice_us = 3000
kernel.sched_migration_cost_ns = 500000

# Reduce CPU scheduling overhead
kernel.sched_nr_migrate = 8

# CPU isolation (if needed, adjust based on your CPU cores)
# kernel.isolcpus = 4-7
EOF
  
  sudo sysctl --system
  print_success "Kernel parameters configured"
else
  print_info "Gaming kernel parameters already configured"
fi

# Create tmpfiles configuration for runtime parameter tuning
print_info "Setting up runtime parameter tuning..."

if [ ! -f /etc/tmpfiles.d/gaming-runtime-tuning.conf ]; then
  sudo tee /etc/tmpfiles.d/gaming-runtime-tuning.conf > /dev/null <<'EOF'
# Gaming runtime parameter tuning
# Path                                          Mode UID  GID  Age Argument
w /proc/sys/vm/compaction_proactiveness        -    -    -    -   0
w /proc/sys/vm/watermark_boost_factor          -    -    -    -   1
w /proc/sys/vm/watermark_scale_factor          -    -    -    -   500
w /proc/sys/vm/swappiness                      -    -    -    -   10
w /proc/sys/vm/zone_reclaim_mode               -    -    -    -   0
w /proc/sys/vm/page_lock_unfairness            -    -    -    -   1
w /proc/sys/kernel/sched_child_runs_first      -    -    -    -   0
w /proc/sys/kernel/sched_autogroup_enabled     -    -    -    -   1
w /proc/sys/kernel/sched_cfs_bandwidth_slice_us -   -    -    -   3000
w /sys/kernel/debug/sched/migration_cost_ns    -    -    -    -   500000
w /sys/kernel/debug/sched/nr_migrate           -    -    -    -   8
EOF
  
  sudo systemd-tmpfiles --create
  print_success "Runtime parameter tuning configured"
else
  print_info "Runtime parameter tuning already configured"
fi

# Optional: Apply PCI Express latency tuning
print_info "Applying PCI Express latency optimizations..."
if command -v setpci >/dev/null 2>&1; then
  # Note: These require root and may need to be run at boot time
  print_warning "PCI-E latency tuning requires manual setup via boot parameters or init script"
  print_info "Consider adding to /etc/rc.local or systemd service if needed"
else
  print_warning "setpci not found, skipping PCI-E latency tuning"
fi

# Create a gaming environment setup script
print_info "Creating gaming environment helper script..."

mkdir -p ~/.local/bin

cat > ~/.local/bin/gaming-env <<'GAMESCRIPT'
#!/bin/bash
# Gaming environment setup helper

# Enable gamemode
export GAMEMODE=1
export GAMEMODERUNEXEC=env

# Performance settings
export DXVK_HUD=fps,memory
export DXVK_ASYNC=1
export VKD3D_FEATURE_LEVEL=12_1

# Wine settings for best compatibility
export WINE_CPU_TOPOLOGY=4:2
export PROTON_NO_ESYNC=0
export PROTON_NO_FSYNC=0

# Reduce input latency
export RADV_PERFTEST=aco,navi10_ngg_culling
export MESA_DRIVER=radeonsi

echo "Gaming environment configured:"
echo "  - GameMode enabled"
echo "  - DXVK async compilation enabled"
echo "  - VKD3D feature level 12.1"
echo ""
echo "To use these settings, prefix your game command with:"
echo "  source ~/.local/bin/gaming-env"
GAMESCRIPT

chmod +x ~/.local/bin/gaming-env

print_success "Gaming environment helper script created"

# Create documentation
print_info "Creating gaming setup documentation..."

mkdir -p ~/.local/share/doc/gaming

cat > ~/.local/share/doc/gaming/SETUP.md <<'GAMEDOC'
# Gaming Setup on Arch Linux

## Installed Components

### Core Gaming Tools
- **Steam**: Digital game distribution platform
- **Proton (GE-Custom)**: Advanced Proton build for better compatibility
- **Wine/Winetricks**: Windows compatibility layer
- **Lutris**: Open gaming platform with game runners
- **Heroic Games Launcher**: GOG and Epic Games support

### Performance Tools
- **GameMode**: Automatic performance optimizations
- **Gamescope**: Micro-compositor for better gaming isolation
- **MangoHUD**: In-game FPS and resource monitoring overlay
- **Goverlay**: GUI for MangoHUD and ReShade configuration
- **Bottles**: Windows app management with Wine/Proton

### Graphics & Libraries
- **DXVK/VKD3D**: DirectX to Vulkan translation
- **Vulkan Tools**: Vulkan debugging and analysis
- **OpenAL**: 3D audio support

### Utilities
- **Piper**: Gaming mouse configuration
- **Solaar**: Logitech device management
- **OpenRGB**: RGB LED control

## Kernel Optimizations

The following kernel parameters have been configured for better gaming performance:
- Increased vm.max_map_count for memory management
- Reduced memory fragmentation and jitter
- Optimized CPU scheduling
- Better process fairness

See `/etc/sysctl.d/80-gamecompatibility.conf` for details.

## Quick Start

### Running a Game Through Steam
1. Install Steam: Done!
2. Log in to Steam
3. Games will automatically use Proton when needed

### Running Windows Games Through Wine
1. Use Lutris for managed installations
2. Use Heroic Games Launcher for GOG/Epic games
3. Use Bottles for Windows applications

### Performance Tuning

#### Enable Gaming Environment
```bash
source ~/.local/bin/gaming-env
```

#### Monitor Performance with MangoHUD
```bash
mangohud steam
# or
mangohud lutris
```

#### Access Goverlay GUI
```bash
goverlay
```

## Recommended Settings

### DXVK Configuration
- Async compilation: Enabled (reduces stuttering)
- Feature level: DirectX 12.1 (better compatibility)

### Wine Configuration
- ESYNC/FSYNC: Enabled for lower latency
- ACO compiler: Enabled for AMD GPUs (if applicable)

### AMD GPU Specific
Set in gaming-env or launch script:
```bash
export RADV_PERFTEST=aco,navi10_ngg_culling
export MESA_DRIVER=radeonsi
```

## Troubleshooting

### Game Won't Launch
1. Check Lutris wiki for game-specific configurations
2. Try Proton version switching (right-click game in Steam)
3. Use Winetricks to install runtime dependencies

### Poor Performance
1. Enable MangoHUD to see resource usage
2. Adjust GPU driver settings for your card
3. Check CPU/GPU temperatures (might be throttling)
4. Disable V-Sync in-game for lower latency

### Audio Issues
1. Ensure ALSA/PulseAudio is properly configured
2. Try enabling OpenAL HRTF for spatial audio
3. Check game-specific audio settings

## Resources

- [Arch Linux Gaming Wiki](https://wiki.archlinux.org/title/Gaming)
- [ProtonDB](https://www.protondb.com/) - Check game compatibility
- [Lutris Games Database](https://lutris.net/) - Game runners and configs
- [Wine Documentation](https://wiki.winehq.org/)

## Useful Commands

```bash
# List installed Steam games
steam-run steam +apps_list

# Clear Proton/Wine prefix (fresh install)
rm -rf ~/.steam/steamapps/compatdata/[GAME_ID]

# Check system capabilities
vulkaninfo
glxinfo

# Monitor GPU performance
radeontop  # AMD
nvidia-smi # NVIDIA

# Configure mouse DPI/polling rate
piper

# Test DirectX support
wine cmd /c dxdiag
```
GAMEDOC

print_success "Gaming documentation created at ~/.local/share/doc/gaming/"

print_section "Gaming Setup Completed!"

echo -e "${GREEN}Summary:${NC}"
echo "  • Core gaming tools installed (Steam, Proton, Lutris, etc.)"
echo "  • Performance libraries configured (DXVK, VKD3D, Vulkan)"
echo "  • Kernel parameters optimized for gaming"
echo "  • Gaming environment helper: ~/.local/bin/gaming-env"
echo "  • Documentation: ~/.local/share/doc/gaming/SETUP.md"
echo ""
echo -e "${BLUE}Next steps:${NC}"
echo "  1. Log in to Steam and install games"
echo "  2. Use 'source ~/.local/bin/gaming-env' before gaming sessions"
echo "  3. Monitor performance with 'mangohud steam'"
echo "  4. Check ProtonDB for game-specific configurations"
echo ""

{{- else }}

print_section "Gaming Setup"
print_info "Skipping gaming setup (disabled in configuration)"

{{- end }}

{{ end -}}
