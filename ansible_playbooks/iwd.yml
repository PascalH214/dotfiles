---
- name: Configure iwd (iNet Wireless Daemon)
  hosts: localhost
  connection: local
  become: true
  tasks:
    - name: Disable NetworkManager if present
      ansible.builtin.systemd:
        name: NetworkManager
        state: stopped
        enabled: false
      ignore_errors: true

    - name: Disable wpa_supplicant service
      ansible.builtin.systemd:
        name: wpa_supplicant
        state: stopped
        enabled: false
      ignore_errors: true
    - name: Ensure /etc/iwd directory exists
      ansible.builtin.file:
        path: /etc/iwd
        state: directory
        mode: '0755'
        owner: root
        group: root

    - name: Configure iwd main.conf
      ansible.builtin.copy:
        dest: /etc/iwd/main.conf
        content: |
          [General]
          EnableNetworkConfiguration=true
          # Roaming threshold to prevent excessive roaming
          RoamThreshold=-65
          # Use stronger signal requirements
          RSSIThreshold=-85

          [Network]
          EnableIPv6=true
          NameResolvingService=systemd

          [Scan]
          # Disable periodic background scans that cause disconnects
          DisablePeriodicScan=false
          # Increase scan interval to reduce RF interference
          BackgroundScanPeriod=300
        mode: '0644'
        owner: root
        group: root
      notify: Restart iwd service

    - name: Ensure systemd-resolved drop-in directory exists
      ansible.builtin.file:
        path: /etc/systemd/resolved.conf.d
        state: directory
        mode: '0755'
        owner: root
        group: root

    - name: Configure systemd-resolved DNS (fallback only)
      ansible.builtin.copy:
        dest: /etc/systemd/resolved.conf.d/iwd-dns.conf
        content: |
          [Resolve]
          DNS=192.168.178.221 1.1.1.1 8.8.8.8
          FallbackDNS=1.1.1.1 8.8.8.8
        mode: '0644'
        owner: root
        group: root
      notify: Restart systemd-resolved

    - name: Ensure systemd-resolved is enabled and running
      ansible.builtin.systemd:
        name: systemd-resolved
        state: started
        enabled: true

    - name: Ensure /etc/modprobe.d directory exists
      ansible.builtin.file:
        path: /etc/modprobe.d
        state: directory
        mode: '0755'
        owner: root
        group: root

    - name: Disable WiFi power saving for Intel iwlwifi driver
      ansible.builtin.copy:
        dest: /etc/modprobe.d/iwlwifi.conf
        content: |
          # Disable power saving to prevent WiFi disconnections
          options iwlwifi power_save=0
          options iwldvm force_cam=1
        mode: '0644'
        owner: root
        group: root
      notify: Regenerate initramfs

    - name: Disable WiFi power saving for MediaTek MT792x driver
      ansible.builtin.copy:
        dest: /etc/modprobe.d/mt792x.conf
        content: |
          # Disable power saving for MediaTek MT7922/MT7921 to prevent disconnections
          options mt7921e disable_aspm=1
          options cfg80211 ieee80211_regdom=DE
        mode: '0644'
        owner: root
        group: root
      notify: Regenerate initramfs

    - name: Disable WiFi power saving for other drivers
      ansible.builtin.copy:
        dest: /etc/modprobe.d/wireless-power-save.conf
        content: |
          # Disable power saving globally for wireless devices
          options cfg80211 ieee80211_regdom=DE
          # Disable runtime PM for PCI devices to prevent WiFi dropout
          options pciehp pcie_ports=native
        mode: '0644'
        owner: root
        group: root
      notify: Regenerate initramfs

  handlers:
    - name: Restart iwd service
      ansible.builtin.systemd:
        name: iwd
        state: restarted
        enabled: true

    - name: Restart systemd-resolved
      ansible.builtin.systemd:
        name: systemd-resolved
        state: restarted
        enabled: true

    - name: Regenerate initramfs
      ansible.builtin.command: mkinitcpio -P
      changed_when: true
