---
- name: Configure iwd (iNet Wireless Daemon)
  hosts: localhost
  connection: local
  become: true
  tasks:
    - name: Ensure /etc/iwd directory exists
      ansible.builtin.file:
        path: /etc/iwd
        state: directory
        mode: '0755'
        owner: root
        group: root

    - name: Configure iwd main.conf
      ansible.builtin.copy:
        dest: /etc/iwd/main.conf
        content: |
          [General]
          EnableNetworkConfiguration=true

          [Network]
          EnableIPv6=true
          NameResolvingService=systemd
        mode: '0644'
        owner: root
        group: root
      notify: Restart iwd service

    - name: Ensure systemd-resolved drop-in directory exists
      ansible.builtin.file:
        path: /etc/systemd/resolved.conf.d
        state: directory
        mode: '0755'
        owner: root
        group: root

    - name: Configure systemd-resolved DNS (fallback only)
      ansible.builtin.copy:
        dest: /etc/systemd/resolved.conf.d/iwd-dns.conf
        content: |
          [Resolve]
          DNS=192.168.178.221 1.1.1.1 8.8.8.8
          FallbackDNS=1.1.1.1 8.8.8.8
        mode: '0644'
        owner: root
        group: root
      notify: Restart systemd-resolved

    - name: Ensure systemd-resolved is enabled and running
      ansible.builtin.systemd:
        name: systemd-resolved
        state: started
        enabled: true

  handlers:
    - name: Restart iwd service
      ansible.builtin.systemd:
        name: iwd
        state: restarted
        enabled: true

    - name: Restart systemd-resolved
      ansible.builtin.systemd:
        name: systemd-resolved
        state: restarted
        enabled: true
